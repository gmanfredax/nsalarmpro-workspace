<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Impostazioni Sistema • Alarm Pro - NeXtorSystem</title>
  <link rel="stylesheet" href="/css/style.css" />
  <style>
    /* Layout simile a index.html ma con sidebar sinistra */
    .admin-grid{display:grid;grid-template-columns:220px 1fr;gap:12px;align-items:start}
    .side{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:.6rem}
    .side h4{margin:.2rem .4rem .4rem;font-size:.95rem;color:var(--muted);letter-spacing:.3px}
    .side ul{list-style:none;margin:0;padding:.2rem}
    .side li{margin:.2rem 0}
    .side button{width:100%;text-align:left}
    .side .active{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.18)}
    .view{display:none}
    .view.active{display:block}
    .muted{color:var(--muted)}
    .hidden{display:none}
    .expansion-list{list-style:none;margin:0;padding:10px 0 0 0;display:flex;flex-direction:column;gap:.5rem}
    .expansion-item{display:flex;align-items:flex-start;justify-content:space-between;gap:.75rem;padding:.75rem .9rem;background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:10px}
    .expansion-info{min-width:0;flex:1}
    .expansion-title{font-weight:600;margin-bottom:.2rem;word-break:break-word}
    .expansion-meta{font-size:.85rem;color:var(--muted);display:flex;flex-wrap:wrap;gap:.35rem}
    .expansion-actions{display:flex;flex-wrap:wrap;gap:.4rem;align-items:center;justify-content:flex-end}
    .expansion-empty{padding:.6rem 0;color:var(--muted);font-style:italic}
    .status-line{margin:.6rem 0 0;font-size:.9rem}
    .status-line.error{color:#f87171}
    .status-line.success{color:#34d399}
    .telemetry-grid{display:grid;gap:1rem;margin-top:.75rem}
    @media (min-width:720px){.telemetry-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .telemetry-card{background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:10px;padding:1rem}
    .telemetry-card h4{margin-top:0;margin-bottom:.6rem;font-size:1.05rem}
    .telemetry-metric{display:flex;justify-content:space-between;align-items:center;margin:.35rem 0;font-variant-numeric:tabular-nums}
    .telemetry-metric span{color:var(--muted)}
    .telemetry-metric strong{font-weight:600}
    .telemetry-metric strong.warn{color:#f87171}
    .telemetry-status{margin:.5rem 0;font-size:.9rem;color:var(--muted)}
    .telemetry-status.error{color:#f87171}
    .diag-expected-grid{display:grid;gap:.75rem;margin-top:.75rem}
    @media(min-width:720px){.diag-expected-grid{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}}
    .diag-expected-card{background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:10px;padding:.75rem}
    .diag-expected-card h4{margin:0 0 .5rem}
    .diag-expected-row{display:flex;justify-content:space-between;align-items:center;gap:.4rem;margin:.3rem 0;font-variant-numeric:tabular-nums}
    .diag-expected-row span{color:var(--muted)}
    .diag-expected-row strong{font-weight:600}
    .diag-expected-row em{font-style:normal;color:var(--muted);font-size:.85rem}
    .diag-expected-row small{color:var(--muted);font-size:.75rem}
    #diagStatus{margin:.6rem 0;font-size:.9rem}
    #diagStatus.error{color:#f87171}
    #diagStatus.success{color:#34d399}
    #analogConfigStatus{font-size:.85rem}
    #analogConfigStatus.error{color:#f87171}
    #analogConfigStatus.success{color:#34d399}
    #diagZonesTable tbody tr.status-alarm td,
    #diagZonesTable tbody tr.status-tamper td,
    #diagZonesTable tbody tr.status-fault_short td,
    #diagZonesTable tbody tr.status-fault_open td{color:#fbbf24}
  </style>
</head>
<body>
  <div id="adminDenied" class="container main hidden" style="padding:2rem;text-align:center;">
    <div class="card" style="max-width:720px;margin:2rem auto;">
      <h2>Accesso negato</h2>
      <p class="muted">Questa pagina è accessibile solo all’amministratore.</p>
    </div>
  </div>
  <div id="appRoot" class="app hidden">
    <header class="site-header">
      <div class="container head-inner">
        <div class="brand">
          <svg xmlns="http://www.w3.org/2000/svg" class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M7 11a5 5 0 1 1 10 0v4H7v-4Z"/><path d="M5 19h14"/>
            <path d="M21 11h1"/><path d="M2 11h1"/><path d="M18.5 5.5 19 5"/><path d="m4.5 5.5-.5-.5"/>
          </svg>
          <span class="brand-name">Alarm Pro - NeXtorSystem</span>
        </div>
        <nav class="nav">
          <div class="user user-menu">
            <button id="userBtn" class="user-btn">
              <svg xmlns="http://www.w3.org/2000/svg" class="ico s" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="7.5" cy="7.5" r="3"/><path d="M10.2 10.2 21 21"/><path d="m18 15 3 3"/>
              </svg>
              <span id="userLabel"></span>
            </button>
            <div id="userDropdown" class="dropdown hidden">
              <button data-act="logout">Logout</button>
            </div>
          </div>
        </nav>
      </div>
    </header>

    <main class="container main">
      <div class="tabs">
        <button class="tab-btn" data-tab="home">HOME</button>
        <button class="tab-btn active" data-tab="sys_settings">IMPOSTAZIONI SISTEMA</button>
      </div>
      <h2 class="title" style="margin:1rem 0">Impostazioni di sistema</h2>

      <div class="admin-grid">
        <aside class="side">
          <h4>Sezioni</h4>
          <ul>
            <li><button class="btn w-100 active" data-view="view-users">Utenti</button></li>
            <li><button class="btn w-100" data-view="view-network">Rete</button></li>
            <li><button class="btn w-100" data-view="view-mqtt">MQTT</button></li>
            <li><button class="btn w-100" data-view="view-websec">Sicurezza web</button></li>
            <li><button class="btn w-100" data-view="view-expansions">Espansioni CAN</button></li>
            <li><button class="btn w-100" data-view="view-diagnostics">Diagnostica Sistema</button></li>
          </ul>
        </aside>

        <section>
          <!-- UTENTI -->
          <section id="view-users" class="view active">
            <div class="card">
              <div class="row" style="justify-content:space-between;align-items:center;gap:.5rem">
                <h3>Utenti</h3>
                <button class="btn" id="btnNewUser">+ Nuovo utente</button>
              </div>
              <div class="table-wrap" style="margin-top:.5rem">
                <table class="table">
                  <thead>
                    <tr><th>Username</th><th>Nome</th><th>Cognome</th><th>PIN</th><th>RFID</th><th>TOTP</th><th>Azioni</th></tr>
                  </thead>
                  <tbody id="usersTbody"><tr><td colspan="7">Caricamento…</td></tr></tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- RETE -->
          <section id="view-network" class="view">
            <div class="card">
              <h3>Rete</h3>
              <form class="form" id="netForm">
                <div class="row" style="gap:1rem;flex-wrap:wrap">
                  <div class="field"><span>Hostname</span><input id="net_host" type="text" placeholder="centrale-esp32" /></div>
                  <div class="field"><span>DHCP</span>
                    <select id="net_dhcp"><option value="1">Abilitato</option><option value="0">Statico</option></select>
                  </div>
                </div>
                <div id="net_static" class="row" style="gap:1rem;flex-wrap:wrap;margin-top:.4rem;display:none">
                  <div class="field"><span>IP</span><input id="net_ip" type="text" placeholder="192.168.1.50" /></div>
                  <div class="field"><span>Gateway</span><input id="net_gw" type="text" placeholder="192.168.1.1" /></div>
                  <div class="field"><span>Subnet</span><input id="net_mask" type="text" placeholder="255.255.255.0" /></div>
                  <div class="field"><span>DNS</span><input id="net_dns" type="text" placeholder="1.1.1.1" /></div>
                </div>
                <div class="row" style="justify-content:flex-end;margin-top:.6rem">
                  <button class="btn" id="btnNetSave" type="button">Salva</button>
                </div>
                <small class="muted">Nota: le impostazioni di rete non sono ancora gestite dal firmware; il salvataggio verrà abilitato in seguito.</small>
              </form>
            </div>
          </section>

          <!-- MQTT -->
          <section id="view-mqtt" class="view">
            <div class="card">
              <h3>MQTT</h3>
              <form class="form" id="mqttForm">
                <div class="row" style="gap:1rem;flex-wrap:wrap">
                  <div class="field"><span>URI broker</span><input id="mq_uri" type="text" placeholder="mqtt://192.168.1.10:1883" /></div>
                  <div class="field"><span>Client ID</span><input id="mq_cid" type="text" placeholder="CentraleESP32-xxxx" /></div>
                </div>
                <div class="row" style="gap:1rem;flex-wrap:wrap">
                  <div class="field"><span>Username</span><input id="mq_user" type="text" /></div>
                  <div class="field"><span>Password</span><input id="mq_pass" type="password" /></div>
                  <div class="field"><span>Keepalive (s)</span><input id="mq_keep" type="number" min="10" max="600" value="60" /></div>
                </div>
                <div class="row" style="justify-content:flex-end;margin-top:.6rem">
                  <button class="btn" id="btnMqttSave" type="button">Salva</button>
                </div>
                <small class="muted">Nota: le impostazioni MQTT sono attualmente da Kconfig; il salvataggio runtime verrà abilitato in seguito.</small>
              </form>
            </div>
          </section>

          <!-- SICUREZZA WEB -->
          <section id="view-websec" class="view">
            <div class="card">
              <h3>Sicurezza web</h3>
              <p class="muted">Gestisci il certificato HTTPS utilizzato dal server integrato. I file devono essere in formato PEM e la chiave privata deve corrispondere al certificato.</p>
              <div id="websecStatus" class="muted" style="margin-bottom:.6rem">Caricamento stato…</div>
              <form class="form" id="websecForm">
                <div class="row" style="gap:1rem;flex-wrap:wrap">
                  <label class="field" style="min-width:220px"><span>Certificato (PEM)</span>
                    <input id="websecCert" type="file" accept=".pem,.crt,.cer" />
                  </label>
                  <label class="field" style="min-width:220px"><span>Chiave privata (PEM)</span>
                    <input id="websecKey" type="file" accept=".pem,.key" />
                  </label>
                </div>
                <small class="muted">I file vengono inviati codificati in Base64. Dimensione massima consigliata: 4&nbsp;KB per file.</small>
                <div class="row" style="justify-content:flex-end;margin-top:.6rem">
                  <button class="btn" id="btnWebsecUpload" type="button">Aggiorna certificato</button>
                </div>
              </form>
              <div id="websecFeedback" class="muted" style="margin-top:.4rem;font-size:.85rem"></div>
            </div>
          </section>
          <!-- ESPANSIONI CAN -->
          <section id="view-expansions" class="view">
            <div class="card">
              <div class="row" style="justify-content:space-between;align-items:center;gap:.5rem;flex-wrap:wrap">
                <h3>Espansioni CAN</h3>
                <div class="row" style="gap:.4rem;flex-wrap:wrap">
                  <button class="btn outline" id="adminExpansionRefreshBtn" type="button">Aggiorna elenco</button>
                  <button class="btn" id="adminExpansionScanBtn" type="button">+ Scansiona nuove schede</button>
                </div>
              </div>
              <div style="margin-top:.75rem;">
                <div class="row" style="gap:.6rem;flex-wrap:wrap;align-items:center;">
                  <span style="font-weight:600;">CAN — Smoke Test</span>
                  <div class="row" style="gap:.4rem;flex-wrap:wrap;align-items:center;">
                    <button class="btn" id="canTestBroadcastOnBtn" type="button">BUS ON</button>
                    <button class="btn outline" id="canTestBroadcastOffBtn" type="button">BUS OFF</button>
                  </div>
                  <span id="canTestBroadcastStatus" class="muted">Premi un pulsante per inviare un broadcast sul bus CAN.</span>
                </div>
              </div>
              <p id="adminExpansionStatus" class="status-line muted hidden" role="status"></p>
              <ul id="adminExpansionList" class="expansion-list"></ul>
              <p id="adminExpansionEmpty" class="expansion-empty hidden">Nessuna scheda rilevata.</p>
            </div>
          </section>

          <!-- DIAGNOSTICA SISTEMA -->
          <section id="view-diagnostics" class="view">
            <div class="card">
              <h3>Configurazione front-end zone</h3>
              <form id="analogConfigForm" class="form" style="margin-top:.6rem">
                <div class="row" style="gap:1rem;flex-wrap:wrap">
                  <label class="field"><span>R<sub>N</sub> (Ω)</span><input id="analog_r_normal" type="number" min="0" step="1"></label>
                  <label class="field"><span>R<sub>A</sub> (Ω)</span><input id="analog_r_alarm" type="number" min="0" step="1"></label>
                  <label class="field"><span>R<sub>T</sub> (Ω)</span><input id="analog_r_tamper" type="number" min="0" step="1"></label>
                  <label class="field"><span>R<sub>E</sub> (Ω)</span><input id="analog_r_eol" type="number" min="0" step="1"></label>
                </div>
                <div class="row" style="gap:1rem;flex-wrap:wrap;margin-top:.6rem">
                  <label class="field"><span>Soglia corto (Ω)</span><input id="analog_short_threshold" type="number" min="0" step="1"></label>
                  <label class="field"><span>Soglia aperto (Ω)</span><input id="analog_open_threshold" type="number" min="0" step="1"></label>
                  <label class="field"><span>Debounce (ms)</span><input id="analog_debounce_ms" type="number" min="0" step="1"></label>
                  <label class="field"><span>Isteresi (%)</span><input id="analog_hysteresis_pct" type="number" min="0" step="0.1"></label>
                </div>
                <div class="row" style="gap:.6rem;align-items:center;margin-top:.8rem">
                  <button class="btn" type="submit">Salva configurazione</button>
                  <span id="analogConfigStatus" class="muted"></span>
                </div>
              </form>
              <div class="table-wrap" style="margin-top:.75rem">
                <table class="table" id="analogZoneConfig">
                  <thead><tr><th>Zona</th><th>Nome</th><th>Modo</th><th>Contatto</th></tr></thead>
                  <tbody id="analogZoneConfigBody"><tr><td colspan="4">Caricamento…</td></tr></tbody>
                </table>
              </div>
            </div>

            <div class="card" style="margin-top:1rem">
              <div class="row" style="justify-content:space-between;align-items:center;gap:.6rem;flex-wrap:wrap">
                <h3>Diagnostica sistema</h3>
                <div class="row" style="gap:.6rem;align-items:center;flex-wrap:wrap">
                  <span class="muted small">Backend: <strong id="diagBackend">—</strong></span>
                  <button class="btn" id="diagRefreshBtn" type="button">Aggiorna diagnostica</button>
                </div>
              </div>
              <div id="diagStatus" class="muted" style="margin-top:.5rem">Premi “Aggiorna diagnostica” per leggere i valori correnti.</div>
              <div id="diagExpected" class="diag-expected-grid" style="margin-top:.5rem"></div>
              <div class="table-wrap" style="margin-top:1rem">
                <table class="table" id="diagZonesTable">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Nome</th>
                      <th>Stato</th>
                      <th>Presente</th>
                      <th>Modo</th>
                      <th>Contatto</th>
                      <th>Vz</th>
                      <th>Vbias</th>
                      <th>Rloop</th>
                      <th>Scheda</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr><td colspan="10">Premi “Aggiorna diagnostica” per visualizzare i dati.</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>
        </section>
      </div>
    </main>

    <footer class="container foot">
      <small>Powered by NeXtorSystem — &copy; <span id="year"></span></small>
    </footer>
  </div>

  <div id="modals-root"></div>

  <script src="/js/admin.js" defer></script>
</body>
</html>